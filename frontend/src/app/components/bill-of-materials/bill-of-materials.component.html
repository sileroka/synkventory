<div class="bom-container">
  <p-toast />
  <p-confirmDialog />

  <!-- Header with actions -->
  <div class="bom-header flex justify-content-between align-items-center mb-4">
    <div class="bom-title">
      <h3 class="m-0">Bill of Materials</h3>
      <p class="text-500 mt-1 mb-0">Components needed to build this item</p>
    </div>
    <div class="bom-actions flex gap-2">
      <p-button
        *ngIf="hasBom()"
        icon="pi pi-cog"
        label="Build"
        severity="success"
        [disabled]="maxBuildable() === 0"
        (onClick)="openBuildDialog()"
        pTooltip="Build assemblies from components"
        tooltipPosition="left"
      />
      <p-button
        *ngIf="hasBom()"
        icon="pi pi-undo"
        label="Unbuild"
        severity="warning"
        [disabled]="itemQuantity === 0"
        (onClick)="openUnbuildDialog()"
        pTooltip="Disassemble back into components"
        tooltipPosition="left"
      />
      <p-button
        icon="pi pi-plus"
        label="Add Component"
        (onClick)="openAddDialog()"
      />
    </div>
  </div>

  <!-- Availability Summary -->
  <div
    *ngIf="availability()"
    class="availability-card mb-4 p-3 border-round surface-card border-1 surface-border"
  >
    <div class="flex align-items-center gap-3">
      <div
        class="availability-icon flex align-items-center justify-content-center border-circle"
        [style.background-color]="maxBuildable() > 0 ? '#10B981' : '#EF4444'"
        style="width: 48px; height: 48px"
      >
        <i class="pi pi-box text-white text-xl"></i>
      </div>
      <div class="flex-1">
        <div class="text-600 text-sm">Available to Build</div>
        <div
          class="text-2xl font-semibold"
          [class.text-green-500]="maxBuildable() > 0"
          [class.text-red-500]="maxBuildable() === 0"
        >
          {{ maxBuildable() }} units
        </div>
      </div>
      <div class="text-right">
        <div class="text-600 text-sm">Current Stock</div>
        <div class="text-xl font-medium">{{ itemQuantity }}</div>
      </div>
      <div class="text-right">
        <div class="text-600 text-sm">Component Cost</div>
        <div class="text-xl font-medium">
          {{ totalComponentCost() | currency }}
        </div>
      </div>
    </div>
  </div>

  <!-- Components Table -->
  <div class="content-card">
    <p-table
      [value]="bomComponents()"
      [loading]="isLoading()"
      styleClass="p-datatable-sm"
      [rowHover]="true"
    >
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 60px">#</th>
          <th style="width: 60px">Image</th>
          <th>Component</th>
          <th style="width: 100px">SKU</th>
          <th style="width: 120px">Qty Required</th>
          <th style="width: 120px">In Stock</th>
          <th style="width: 100px">Unit Price</th>
          <th style="width: 100px">Status</th>
          <th style="width: 100px">Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-comp let-rowIndex="rowIndex">
        <tr>
          <td>{{ rowIndex + 1 }}</td>
          <td>
            <img
              *ngIf="comp.componentItem?.imageUrl"
              [src]="comp.componentItem.imageUrl"
              [alt]="comp.componentItem?.name"
              class="border-round"
              style="width: 40px; height: 40px; object-fit: cover"
            />
            <span
              *ngIf="!comp.componentItem?.imageUrl"
              class="flex align-items-center justify-content-center border-round surface-200"
              style="width: 40px; height: 40px"
            >
              <i class="pi pi-image text-400"></i>
            </span>
          </td>
          <td>
            <div class="font-medium">{{ comp.componentItem?.name }}</div>
            <div *ngIf="comp.notes" class="text-500 text-sm">
              {{ comp.notes }}
            </div>
          </td>
          <td class="text-500">{{ comp.componentItem?.sku }}</td>
          <td class="font-semibold">
            {{ comp.quantityRequired }}
            <span class="text-500 font-normal">{{ comp.unitOfMeasure }}</span>
          </td>
          <td>
            <span
              [class.text-green-500]="
                (comp.componentItem?.quantity ?? 0) >= comp.quantityRequired
              "
              [class.text-orange-500]="
                (comp.componentItem?.quantity ?? 0) > 0 &&
                (comp.componentItem?.quantity ?? 0) < comp.quantityRequired
              "
              [class.text-red-500]="(comp.componentItem?.quantity ?? 0) === 0"
            >
              {{ comp.componentItem?.quantity ?? 0 }}
            </span>
          </td>
          <td>{{ comp.componentItem?.unitPrice | currency }}</td>
          <td>
            <p-tag
              [value]="getStatusLabel(comp.componentItem?.status || '')"
              [severity]="getStatusSeverity(comp.componentItem?.status || '')"
            />
          </td>
          <td>
            <div class="flex gap-1">
              <p-button
                icon="pi pi-trash"
                [rounded]="true"
                [text]="true"
                severity="danger"
                (onClick)="confirmDeleteComponent(comp)"
                pTooltip="Remove from BOM"
                tooltipPosition="left"
              />
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="9" class="text-center p-4">
            <div class="text-500">
              <i class="pi pi-list text-4xl mb-3 block"></i>
              <p class="m-0 mb-2">No components defined</p>
              <p class="m-0 text-sm">
                Add components to define how this item is built
              </p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <!-- Add Component Dialog -->
  <p-dialog
    header="Add Component"
    [(visible)]="showAddDialog"
    [modal]="true"
    [style]="{ width: '500px' }"
    [closable]="true"
    (onHide)="closeAddDialog()"
  >
    <div class="flex flex-column gap-4">
      <!-- Component Search -->
      <div class="field">
        <label for="componentSearch" class="font-medium mb-2 block"
          >Component Item *</label
        >
        <p-autoComplete
          id="componentSearch"
          [(ngModel)]="selectedItem"
          [suggestions]="itemSuggestions()"
          (completeMethod)="searchItems($event)"
          (onSelect)="onItemSelect($event.value)"
          field="name"
          [dropdown]="true"
          placeholder="Search for an item..."
          styleClass="w-full"
          [inputStyleClass]="'w-full'"
        >
          <ng-template let-item pTemplate="item">
            <div class="flex align-items-center gap-2">
              <div>
                <div class="font-medium">{{ item.name }}</div>
                <div class="text-500 text-sm">
                  {{ item.sku }} Â· {{ item.quantity }} in stock
                </div>
              </div>
            </div>
          </ng-template>
        </p-autoComplete>
      </div>

      <!-- Quantity Required -->
      <div class="field">
        <label for="quantityRequired" class="font-medium mb-2 block"
          >Quantity Required *</label
        >
        <p-inputNumber
          id="quantityRequired"
          [(ngModel)]="newComponent().quantityRequired"
          [min]="1"
          [showButtons]="true"
          styleClass="w-full"
        />
        <small class="text-500"
          >How many of this component needed per assembly</small
        >
      </div>

      <!-- Unit of Measure -->
      <div class="field">
        <label for="unitOfMeasure" class="font-medium mb-2 block"
          >Unit of Measure</label
        >
        <input
          id="unitOfMeasure"
          type="text"
          pInputText
          [(ngModel)]="newComponent().unitOfMeasure"
          placeholder="e.g., units, kg, meters"
          class="w-full"
        />
      </div>

      <!-- Notes -->
      <div class="field">
        <label for="notes" class="font-medium mb-2 block">Notes</label>
        <textarea
          id="notes"
          pInputTextarea
          [(ngModel)]="newComponent().notes"
          rows="2"
          class="w-full"
          placeholder="Optional notes about this component"
        ></textarea>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <p-button
        label="Cancel"
        [text]="true"
        severity="secondary"
        (onClick)="closeAddDialog()"
      />
      <p-button
        label="Add Component"
        icon="pi pi-plus"
        (onClick)="addComponent()"
        [disabled]="!selectedItem()"
      />
    </ng-template>
  </p-dialog>

  <!-- Build Dialog -->
  <p-dialog
    header="Build Assembly"
    [(visible)]="showBuildDialog"
    [modal]="true"
    [style]="{ width: '600px' }"
    [closable]="true"
    (onHide)="closeBuildDialog()"
  >
    <div class="flex flex-column gap-4">
      <div class="build-summary p-3 border-round surface-100">
        <div class="text-lg font-semibold mb-2">Building: {{ itemName }}</div>
        <div class="text-500">
          Maximum buildable with current stock:
          <strong class="text-primary">{{ maxBuildable() }}</strong>
        </div>
      </div>

      <!-- Quantity to Build -->
      <div class="field">
        <label for="buildQuantity" class="font-medium mb-2 block"
          >Quantity to Build</label
        >
        <p-inputNumber
          id="buildQuantity"
          [(ngModel)]="buildQuantity"
          [min]="1"
          [max]="maxBuildable()"
          [showButtons]="true"
          styleClass="w-full"
        />
      </div>

      <!-- Component Consumption Preview -->
      <div class="field">
        <label class="font-medium mb-2 block">Components to be Consumed</label>
        <div class="border-1 surface-border border-round">
          <div
            *ngFor="let comp of availability()?.components; let isLast = last"
            class="flex justify-content-between align-items-center p-2 border-bottom-1 surface-border"
            [class.border-bottom-none]="isLast"
          >
            <span>{{ comp.componentName }}</span>
            <span class="font-semibold">
              {{ comp.quantityRequired * buildQuantity() }} of
              {{ comp.quantityAvailable }}
            </span>
          </div>
        </div>
      </div>

      <!-- Notes -->
      <div class="field">
        <label for="buildNotes" class="font-medium mb-2 block">Notes</label>
        <textarea
          id="buildNotes"
          pInputTextarea
          [(ngModel)]="buildNotes"
          rows="2"
          class="w-full"
          placeholder="Optional notes for this build operation"
        ></textarea>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <p-button
        label="Cancel"
        [text]="true"
        severity="secondary"
        (onClick)="closeBuildDialog()"
      />
      <p-button
        label="Build Assembly"
        icon="pi pi-cog"
        severity="success"
        (onClick)="buildAssembly()"
        [disabled]="!canBuild()"
      />
    </ng-template>
  </p-dialog>

  <!-- Unbuild Dialog -->
  <p-dialog
    header="Disassemble"
    [(visible)]="showUnbuildDialog"
    [modal]="true"
    [style]="{ width: '600px' }"
    [closable]="true"
    (onHide)="closeUnbuildDialog()"
  >
    <div class="flex flex-column gap-4">
      <div class="unbuild-summary p-3 border-round surface-100">
        <div class="text-lg font-semibold mb-2">
          Disassembling: {{ itemName }}
        </div>
        <div class="text-500">
          Current stock available:
          <strong class="text-primary">{{ itemQuantity }}</strong>
        </div>
      </div>

      <!-- Quantity to Unbuild -->
      <div class="field">
        <label for="unbuildQuantity" class="font-medium mb-2 block"
          >Quantity to Disassemble</label
        >
        <p-inputNumber
          id="unbuildQuantity"
          [(ngModel)]="unbuildQuantity"
          [min]="1"
          [max]="itemQuantity"
          [showButtons]="true"
          styleClass="w-full"
        />
      </div>

      <!-- Component Return Preview -->
      <div class="field">
        <label class="font-medium mb-2 block">Components to be Returned</label>
        <div class="border-1 surface-border border-round">
          <div
            *ngFor="let comp of bomComponents(); let isLast = last"
            class="flex justify-content-between align-items-center p-2 border-bottom-1 surface-border"
            [class.border-bottom-none]="isLast"
          >
            <span>{{ comp.componentItem?.name }}</span>
            <span class="font-semibold text-green-500">
              +{{ comp.quantityRequired * unbuildQuantity() }}
            </span>
          </div>
        </div>
      </div>

      <!-- Notes -->
      <div class="field">
        <label for="unbuildNotes" class="font-medium mb-2 block">Notes</label>
        <textarea
          id="unbuildNotes"
          pInputTextarea
          [(ngModel)]="unbuildNotes"
          rows="2"
          class="w-full"
          placeholder="Optional notes for this disassembly operation"
        ></textarea>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <p-button
        label="Cancel"
        [text]="true"
        severity="secondary"
        (onClick)="closeUnbuildDialog()"
      />
      <p-button
        label="Disassemble"
        icon="pi pi-undo"
        severity="warning"
        (onClick)="unbuildAssembly()"
        [disabled]="!canUnbuild()"
      />
    </ng-template>
  </p-dialog>
</div>
