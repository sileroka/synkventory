<div class="card">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <div class="flex justify-content-between align-items-center mb-4">
    <h1>Inventory Management</h1>
    <p-button label="Add Item" icon="pi pi-plus" (onClick)="showAddDialog()"></p-button>
  </div>

  <!-- Filter Panel -->
  <div class="filter-panel surface-card p-4 border-round mb-4">
    <div class="grid">
      <div class="col-12 md:col-3">
        <label for="search" class="block mb-2 font-medium">Search</label>
        <span class="p-input-icon-left w-full">
          <i class="pi pi-search"></i>
          <input
            pInputText
            id="search"
            [(ngModel)]="searchTerm"
            placeholder="Search name or SKU..."
            class="w-full"
            (keyup.enter)="onSearch()" />
        </span>
      </div>
      <div class="col-12 md:col-2">
        <label for="categoryFilter" class="block mb-2 font-medium">Category</label>
        <p-multiSelect
          id="categoryFilter"
          [(ngModel)]="selectedCategories"
          [options]="categoryMultiOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="All Categories"
          [showClear]="true"
          class="w-full"
          styleClass="w-full"
          (onChange)="onFilterChange()">
        </p-multiSelect>
      </div>
      <div class="col-12 md:col-2">
        <label for="locationFilter" class="block mb-2 font-medium">Location</label>
        <p-multiSelect
          id="locationFilter"
          [(ngModel)]="selectedLocations"
          [options]="locationMultiOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="All Locations"
          [showClear]="true"
          class="w-full"
          styleClass="w-full"
          (onChange)="onFilterChange()">
        </p-multiSelect>
      </div>
      <div class="col-12 md:col-2">
        <label for="statusFilter" class="block mb-2 font-medium">Status</label>
        <p-multiSelect
          id="statusFilter"
          [(ngModel)]="selectedStatuses"
          [options]="statusMultiOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="All Statuses"
          [showClear]="true"
          class="w-full"
          styleClass="w-full"
          (onChange)="onFilterChange()">
        </p-multiSelect>
      </div>
      <div class="col-12 md:col-3 flex align-items-end gap-2">
        <p-button label="Search" icon="pi pi-search" (onClick)="onSearch()"></p-button>
        <p-button
          label="Clear"
          icon="pi pi-filter-slash"
          severity="secondary"
          [outlined]="true"
          (onClick)="clearFilters()"
          [disabled]="!hasActiveFilters()">
        </p-button>
      </div>
    </div>
  </div>

  <!-- Bulk Actions Toolbar -->
  <p-toolbar *ngIf="selectedItems.length > 0" styleClass="mb-4">
    <ng-template #start>
      <span class="font-semibold mr-3">{{ selectedItems.length }} item(s) selected</span>
      <p-button
        label="Delete"
        icon="pi pi-trash"
        severity="danger"
        [outlined]="true"
        class="mr-2"
        (onClick)="bulkDelete()">
      </p-button>
      <p-button
        label="Set In Stock"
        icon="pi pi-check-circle"
        severity="success"
        [outlined]="true"
        class="mr-2"
        (onClick)="bulkStatusChange('in_stock')">
      </p-button>
      <p-button
        label="Set Out of Stock"
        icon="pi pi-times-circle"
        severity="warning"
        [outlined]="true"
        class="mr-2"
        (onClick)="bulkStatusChange('out_of_stock')">
      </p-button>
      <p-button
        label="Export CSV"
        icon="pi pi-download"
        severity="info"
        [outlined]="true"
        (onClick)="exportSelectedToCsv()">
      </p-button>
    </ng-template>
  </p-toolbar>

  <p-table
    #dt
    [value]="items"
    [loading]="loading"
    [paginator]="true"
    [rows]="pageSize"
    [totalRecords]="totalRecords"
    [lazy]="true"
    (onLazyLoad)="onLazyLoad($event)"
    [rowsPerPageOptions]="[10, 25, 50]"
    [tableStyle]="{'min-width': '70rem'}"
    [(selection)]="selectedItems"
    [rowHover]="true"
    dataKey="id"
    [filterDelay]="300"
    [globalFilterFields]="['sku', 'name', 'description']"
    styleClass="p-datatable-striped">

    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem">
          <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
        </th>
        <th style="width: 4rem">Image</th>
        <th pSortableColumn="sku" style="width: 7rem">
          <div class="flex align-items-center justify-content-between">
            <p-columnFilter type="text" field="sku" display="menu" [showMatchModes]="true" [showOperator]="false"></p-columnFilter>
            <span>SKU</span>
            <p-sortIcon field="sku"></p-sortIcon>
          </div>
        </th>
        <th pSortableColumn="name">
          <div class="flex align-items-center justify-content-between">
            <p-columnFilter type="text" field="name" display="menu" [showMatchModes]="true" [showOperator]="false"></p-columnFilter>
            <span>Name</span>
            <p-sortIcon field="name"></p-sortIcon>
          </div>
        </th>
        <th style="width: 10rem">
          <div class="flex align-items-center justify-content-between">
            <p-columnFilter type="text" field="description" display="menu" [showMatchModes]="true" [showOperator]="false"></p-columnFilter>
            <span>Description</span>
          </div>
        </th>
        <th pSortableColumn="quantity" style="width: 6rem">
          <div class="flex align-items-center justify-content-between">
            <p-columnFilter type="numeric" field="quantity" display="menu" [showMatchModes]="true" [showOperator]="false"></p-columnFilter>
            <span>Qty</span>
            <p-sortIcon field="quantity"></p-sortIcon>
          </div>
        </th>
        <th pSortableColumn="reorderPoint" style="width: 6rem">
          <div class="flex align-items-center justify-content-between">
            <p-columnFilter type="numeric" field="reorderPoint" display="menu" [showMatchModes]="true" [showOperator]="false"></p-columnFilter>
            <span>Reorder</span>
            <p-sortIcon field="reorderPoint"></p-sortIcon>
          </div>
        </th>
        <th pSortableColumn="status" style="width: 7rem">
          <div class="flex align-items-center justify-content-between">
            <p-columnFilter field="status" display="menu" [showMatchModes]="false" [showOperator]="false">
              <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                <p-dropdown
                  [options]="statusMultiOptions"
                  (onChange)="filter($event.value)"
                  placeholder="Select"
                  optionLabel="label"
                  optionValue="value"
                  [showClear]="true"
                  appendTo="body">
                </p-dropdown>
              </ng-template>
            </p-columnFilter>
            <span>Status</span>
            <p-sortIcon field="status"></p-sortIcon>
          </div>
        </th>
        <th pSortableColumn="unitPrice" style="width: 6rem">
          <div class="flex align-items-center justify-content-between">
            <p-columnFilter type="numeric" field="unitPrice" display="menu" [showMatchModes]="true" [showOperator]="false" currency="USD"></p-columnFilter>
            <span>Price</span>
            <p-sortIcon field="unitPrice"></p-sortIcon>
          </div>
        </th>
        <th style="width: 7rem">
          <div class="flex align-items-center justify-content-between">
            <p-columnFilter field="category.name" display="menu" [showMatchModes]="false" [showOperator]="false">
              <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                <p-dropdown
                  [options]="categoryMultiOptions"
                  (onChange)="filter($event.value)"
                  placeholder="Select"
                  optionLabel="label"
                  optionValue="value"
                  [showClear]="true"
                  appendTo="body">
                </p-dropdown>
              </ng-template>
            </p-columnFilter>
            <span>Category</span>
          </div>
        </th>
        <th style="width: 7rem">
          <div class="flex align-items-center justify-content-between">
            <p-columnFilter field="location.name" display="menu" [showMatchModes]="false" [showOperator]="false">
              <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                <p-dropdown
                  [options]="locationMultiOptions"
                  (onChange)="filter($event.value)"
                  placeholder="Select"
                  optionLabel="label"
                  optionValue="value"
                  [showClear]="true"
                  appendTo="body">
                </p-dropdown>
              </ng-template>
            </p-columnFilter>
            <span>Location</span>
          </div>
        </th>
        <th style="width: 8rem">Actions</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-item>
      <tr [ngClass]="getRowClass(item)">
        <td>
          <p-tableCheckbox [value]="item"></p-tableCheckbox>
        </td>
        <td>
          <img *ngIf="item.imageUrl" [src]="item.imageUrl" alt="{{ item.name }}"
               class="item-thumbnail border-round"
               style="width: 40px; height: 40px; object-fit: cover;">
          <span *ngIf="!item.imageUrl" class="item-thumbnail-placeholder flex align-items-center justify-content-center border-round surface-200"
                style="width: 40px; height: 40px;">
            <i class="pi pi-image text-400"></i>
          </span>
        </td>
        <td>{{ item.sku }}</td>
        <td>
          <span class="flex align-items-center gap-2">
            <i *ngIf="item.status === 'low_stock'" class="pi pi-exclamation-triangle text-orange-500" pTooltip="Low Stock - Reorder Needed"></i>
            <i *ngIf="item.status === 'out_of_stock'" class="pi pi-times-circle text-red-500" pTooltip="Out of Stock"></i>
            <a class="item-name-link cursor-pointer text-primary hover:underline" (click)="viewItemDetail(item)">{{ item.name }}</a>
          </span>
        </td>
        <td class="text-overflow-ellipsis white-space-nowrap overflow-hidden" style="max-width: 12rem" [pTooltip]="item.description">
          {{ item.description || '-' }}
        </td>
        <td [class.text-orange-500]="item.status === 'low_stock'" [class.text-red-500]="item.status === 'out_of_stock'" [class.font-semibold]="item.status === 'low_stock' || item.status === 'out_of_stock'">
          {{ item.quantity }}
        </td>
        <td>{{ item.reorderPoint }}</td>
        <td>
          <span class="status-badge" [ngClass]="'status-' + item.status">
            {{ getStatusLabel(item.status) }}
          </span>
        </td>
        <td>{{ item.unitPrice | currency }}</td>
        <td>{{ item.category?.name || '-' }}</td>
        <td>{{ item.location?.name || '-' }}</td>
        <td>
          <p-button
            icon="pi pi-eye"
            [rounded]="true"
            [text]="true"
            severity="secondary"
            pTooltip="View Details"
            tooltipPosition="left"
            (onClick)="viewItemDetail(item)">
          </p-button>
          <p-button
            icon="pi pi-sliders-h"
            [rounded]="true"
            [text]="true"
            severity="help"
            pTooltip="Quick Adjust"
            tooltipPosition="left"
            (onClick)="showQuickAdjustDialog(item)">
          </p-button>
          <p-button
            icon="pi pi-pencil"
            [rounded]="true"
            [text]="true"
            severity="info"
            pTooltip="Edit"
            tooltipPosition="left"
            (onClick)="showEditDialog(item)">
          </p-button>
          <p-button
            icon="pi pi-trash"
            [rounded]="true"
            [text]="true"
            severity="danger"
            pTooltip="Delete"
            tooltipPosition="left"
            (onClick)="deleteItem(item)">
          </p-button>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="11" class="text-center">No items found. Click "Add Item" to create one.</td>
      </tr>
    </ng-template>
  </p-table>
</div>

<p-dialog
  [(visible)]="displayDialog"
  [header]="isEditMode ? 'Edit Item' : 'Add Item'"
  [modal]="true"
  [style]="{width: '450px'}"
  [draggable]="false"
  [resizable]="false">

  <div class="flex flex-column gap-3">
    <div>
      <label for="name" class="block mb-2">Name *</label>
      <input pInputText id="name" [(ngModel)]="selectedItem.name" class="w-full" required />
    </div>

    <div>
      <label for="sku" class="block mb-2">SKU *</label>
      <input pInputText id="sku" [(ngModel)]="selectedItem.sku" class="w-full" required />
    </div>

    <div>
      <label for="description" class="block mb-2">Description</label>
      <textarea pInputTextarea id="description" [(ngModel)]="selectedItem.description"
        class="w-full" rows="3"></textarea>
    </div>

    <div>
      <label for="quantity" class="block mb-2">Quantity *</label>
      <p-inputNumber id="quantity" [(ngModel)]="selectedItem.quantity"
        class="w-full" [min]="0"></p-inputNumber>
    </div>

    <div>
      <label for="reorderPoint" class="block mb-2">Reorder Point</label>
      <p-inputNumber id="reorderPoint" [(ngModel)]="selectedItem.reorderPoint"
        class="w-full" [min]="0"></p-inputNumber>
    </div>

    <div>
      <label for="status" class="block mb-2">Status</label>
      <p-dropdown id="status" [(ngModel)]="selectedItem.status"
        [options]="statusOptions" optionLabel="label" optionValue="value"
        class="w-full" styleClass="w-full" appendTo="body"></p-dropdown>
    </div>

    <div>
      <label for="unitPrice" class="block mb-2">Unit Price *</label>
      <p-inputNumber id="unitPrice" [(ngModel)]="selectedItem.unitPrice"
        class="w-full" mode="currency" currency="USD" [min]="0"></p-inputNumber>
    </div>

    <div>
      <label for="category" class="block mb-2">Category</label>
      <p-dropdown id="category" [(ngModel)]="selectedItem.categoryId"
        [options]="categoryOptions" optionLabel="label" optionValue="value"
        placeholder="Select a category"
        class="w-full" styleClass="w-full" appendTo="body"
        (onChange)="onCategoryChange()"></p-dropdown>
    </div>

    <div>
      <label for="location" class="block mb-2">Location</label>
      <p-dropdown id="location" [(ngModel)]="selectedItem.locationId"
        [options]="locationOptions" optionLabel="label" optionValue="value"
        placeholder="Select a location"
        class="w-full" styleClass="w-full" appendTo="body"></p-dropdown>
    </div>

    <!-- Custom Attributes Section -->
    @if (categoryAttributes.length > 0) {
      <div class="custom-attributes-section border-top-1 surface-border pt-3 mt-2">
        <h4 class="text-sm font-semibold text-color-secondary mb-3 flex align-items-center gap-2">
          <i class="pi pi-list"></i>
          Custom Attributes
        </h4>

        @if (loadingAttributes) {
          <div class="flex align-items-center gap-2 p-3">
            <p-progressSpinner [style]="{width: '20px', height: '20px'}" strokeWidth="4"></p-progressSpinner>
            <span class="text-600">Loading attributes...</span>
          </div>
        } @else {
          @for (attr of categoryAttributes; track attr.id) {
            <div class="mb-3">
              <label [for]="'attr_' + attr.key" class="block mb-2">
                {{ attr.name }}
                @if (attr.isRequired) {
                  <span class="text-red-500">*</span>
                }
              </label>

              @switch (attr.attributeType) {
                @case ('text') {
                  <input pInputText
                         [id]="'attr_' + attr.key"
                         [(ngModel)]="selectedItem.customAttributes![attr.key]"
                         class="w-full"
                         [placeholder]="attr.description || ''" />
                }
                @case ('number') {
                  <p-inputNumber
                         [inputId]="'attr_' + attr.key"
                         [(ngModel)]="selectedItem.customAttributes![attr.key]"
                         class="w-full" />
                }
                @case ('boolean') {
                  <div class="flex align-items-center gap-2">
                    <p-checkbox
                           [inputId]="'attr_' + attr.key"
                           [(ngModel)]="selectedItem.customAttributes![attr.key]"
                           [binary]="true" />
                    <label [for]="'attr_' + attr.key" class="text-color-secondary text-sm">{{ attr.description || 'Yes/No' }}</label>
                  </div>
                }
                @case ('date') {
                  <p-calendar
                         [inputId]="'attr_' + attr.key"
                         [(ngModel)]="selectedItem.customAttributes![attr.key]"
                         class="w-full"
                         styleClass="w-full"
                         dateFormat="yy-mm-dd"
                         appendTo="body" />
                }
                @case ('select') {
                  <p-dropdown
                         [inputId]="'attr_' + attr.key"
                         [(ngModel)]="selectedItem.customAttributes![attr.key]"
                         [options]="getSelectOptions(attr)"
                         optionLabel="label"
                         optionValue="value"
                         [placeholder]="attr.description || 'Select an option'"
                         class="w-full"
                         styleClass="w-full"
                         appendTo="body" />
                }
              }

              @if (attr.description && attr.attributeType !== 'boolean') {
                <small class="text-color-secondary block mt-1">{{ attr.description }}</small>
              }
            </div>
          }
        }
      </div>
    }

    <!-- Image Upload Section -->
    <div>
      <label class="block mb-2">Item Image</label>
      <div class="image-upload-container">
        <!-- Image Preview -->
        <div *ngIf="imagePreviewUrl" class="image-preview mb-2" style="position: relative;">
          <img [src]="imagePreviewUrl" alt="Item preview"
               class="border-round"
               style="max-width: 100%; max-height: 200px; object-fit: contain;">
          <p-button
            icon="pi pi-times"
            [rounded]="true"
            severity="danger"
            size="small"
            class="remove-image-btn absolute"
            [style]="{'position': 'absolute', 'top': '5px', 'right': '5px'}"
            (onClick)="removeImage()"
            pTooltip="Remove Image"
            tooltipPosition="left">
          </p-button>
        </div>

        <!-- Upload Button -->
        <div *ngIf="!imagePreviewUrl" class="upload-placeholder flex flex-column align-items-center justify-content-center border-round border-dashed surface-border p-4 cursor-pointer"
             style="border-width: 2px; min-height: 120px;"
             (click)="triggerFileInput()">
          <i class="pi pi-image text-4xl text-400 mb-2"></i>
          <span class="text-600">Click to upload image</span>
          <span class="text-400 text-sm">JPEG, PNG, GIF, WebP (max 10MB)</span>
        </div>

        <!-- Hidden File Input -->
        <input type="file"
               #fileInput
               (change)="onImageSelect($event)"
               accept="image/jpeg,image/png,image/gif,image/webp"
               style="display: none;">

        <!-- Change Image Button (when image exists) -->
        <p-button *ngIf="imagePreviewUrl"
                  label="Change Image"
                  icon="pi pi-upload"
                  severity="secondary"
                  [outlined]="true"
                  size="small"
                  class="mt-2"
                  (onClick)="triggerFileInput()">
        </p-button>
      </div>

      <!-- Upload Progress -->
      <div *ngIf="uploadingImage" class="flex align-items-center gap-2 mt-2">
        <p-progressSpinner [style]="{width: '20px', height: '20px'}" strokeWidth="4"></p-progressSpinner>
        <span class="text-600">Uploading image...</span>
      </div>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <p-button label="Cancel" icon="pi pi-times" (onClick)="displayDialog = false"
      severity="secondary"></p-button>
    <p-button label="Save" icon="pi pi-check" (onClick)="saveItem()" [disabled]="uploadingImage"></p-button>
  </ng-template>
</p-dialog>

<!-- Detail Dialog with Location Quantities -->
<p-dialog
  [(visible)]="displayDetailDialog"
  [header]="detailItem?.name || 'Item Details'"
  [modal]="true"
  [style]="{width: '600px'}"
  [draggable]="false"
  [resizable]="false">

  <div class="flex flex-column gap-4" *ngIf="detailItem">
    <!-- Item Image (if exists) -->
    <div *ngIf="detailItem.imageUrl" class="flex justify-content-center mb-2">
      <img [src]="detailItem.imageUrl" [alt]="detailItem.name"
           class="border-round shadow-2"
           style="max-width: 100%; max-height: 250px; object-fit: contain;">
    </div>

    <!-- Item Summary -->
    <div class="grid">
      <div class="col-6">
        <div class="text-sm text-color-secondary mb-1">SKU</div>
        <div class="font-semibold">{{ detailItem.sku }}</div>
      </div>
      <div class="col-6">
        <div class="text-sm text-color-secondary mb-1">Status</div>
        <span class="status-badge" [ngClass]="'status-' + detailItem.status">
          {{ getStatusLabel(detailItem.status) }}
        </span>
      </div>
      <div class="col-6">
        <div class="text-sm text-color-secondary mb-1">Total Quantity</div>
        <div class="font-semibold text-xl">{{ detailItem.quantity }}</div>
      </div>
      <div class="col-6">
        <div class="text-sm text-color-secondary mb-1">Reorder Point</div>
        <div class="font-semibold">{{ detailItem.reorderPoint }}</div>
      </div>
      <div class="col-6">
        <div class="text-sm text-color-secondary mb-1">Unit Price</div>
        <div class="font-semibold">{{ detailItem.unitPrice | currency }}</div>
      </div>
      <div class="col-6">
        <div class="text-sm text-color-secondary mb-1">Category</div>
        <div class="font-semibold">{{ detailItem.category?.name || '-' }}</div>
      </div>
    </div>

    <!-- Location Quantities -->
    <div>
      <h3 class="text-lg font-semibold mb-3">Quantity by Location</h3>
      <p-table [value]="locationQuantities" [loading]="loadingDetail" styleClass="p-datatable-sm">
        <ng-template pTemplate="header">
          <tr>
            <th>Location</th>
            <th>Bin/Shelf</th>
            <th class="text-right">Quantity</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-locQty>
          <tr>
            <td>{{ locQty.location?.name || 'Unknown' }}</td>
            <td>{{ locQty.binLocation || '-' }}</td>
            <td class="text-right font-semibold">{{ locQty.quantity }}</td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="3" class="text-center text-color-secondary">
              No location quantities recorded. Use stock movements to add inventory to locations.
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <p-button label="Close" icon="pi pi-times" (onClick)="displayDetailDialog = false"
      severity="secondary"></p-button>
  </ng-template>
</p-dialog>

<!-- Quick Adjust Dialog -->
<p-dialog
  [(visible)]="displayQuickAdjustDialog"
  header="Quick Adjust Quantity"
  [modal]="true"
  [style]="{width: '350px'}"
  [draggable]="false"
  [resizable]="false">

  <div class="flex flex-column gap-3" *ngIf="quickAdjustItem">
    <div class="surface-ground border-round p-3">
      <div class="text-sm text-color-secondary mb-1">Item</div>
      <div class="font-semibold">{{ quickAdjustItem.name }}</div>
      <div class="text-sm text-color-secondary mt-1">SKU: {{ quickAdjustItem.sku }}</div>
    </div>

    <div>
      <label for="quickQty" class="block mb-2 font-medium">New Quantity</label>
      <p-inputNumber
        id="quickQty"
        [(ngModel)]="quickAdjustQuantity"
        class="w-full"
        [min]="0"
        [showButtons]="true"
        buttonLayout="horizontal"
        incrementButtonIcon="pi pi-plus"
        decrementButtonIcon="pi pi-minus">
      </p-inputNumber>
      <small class="text-color-secondary">Current: {{ quickAdjustItem.quantity }}</small>
    </div>

    <div>
      <label for="quickReason" class="block mb-2">Reason (optional)</label>
      <input pInputText id="quickReason" [(ngModel)]="quickAdjustReason"
        class="w-full" placeholder="e.g., Inventory count adjustment" />
    </div>
  </div>

  <ng-template pTemplate="footer">
    <p-button label="Cancel" icon="pi pi-times" (onClick)="displayQuickAdjustDialog = false"
      severity="secondary"></p-button>
    <p-button label="Adjust" icon="pi pi-check" (onClick)="saveQuickAdjust()"></p-button>
  </ng-template>
</p-dialog>
